resources:
- repo: self
queue:
  name: Hosted VS2017
variables:
  github_org: 'Azure-Samples'
  github_repo: 'AI-Gallery'
  github_username: '$(user-staging)'
  github_access_token: '$(pat-staging)'
steps:
- task: AzureKeyVault@1
  displayName: 'Azure Key Vault: gallery-cicd-keyvault'
  inputs:
    azureSubscription: GalleryAzureSubscriptionConnection

    KeyVaultName: 'gallery-cicd-keyvault'


- script: 'npm install'
  workingDirectory: src/product/galleryUI

  displayName: 'Install Packages to UI folder'

- script: |
   npm test
   
  workingDirectory: src/product/galleryUI

  displayName: 'Run Tests'

- script: 'npm run build'
  workingDirectory: src/product/galleryUI

  displayName: Webpack

- task: CopyFiles@2
  displayName: 'Copy Files to: $(build.artifactstagingdirectory)'
  inputs:
    SourceFolder: src/product/galleryUI

    Contents: |
     **\dist\**
     index.md
     **/src/css/**
     _config.yml
     .github/ISSUE_TEMPLATE.md
     .github/PULL_REQUEST_TEMPLATE.md
     .gitignore
     CHANGELOG.md
     CONTRIBUTING.md
     README.md

    TargetFolder: '$(build.artifactstagingdirectory)'

    CleanTargetFolder: true


- script: |
   cd $(build.artifactstagingdirectory)
   rm -r ./node_modules
   
   ls -a
  displayName: 'Remove Node_Modules'

- script: |
   cd $(build.artifactstagingdirectory)
   
   ls -a
  displayName: 'Enter Staging Directory'

- task: PowerShell@2
  displayName: 'Push to github'
  inputs:
    targetType: ./

    filePath: 'src/product/CICD/Deploy/push_to_github.ps1'

    arguments: '-github_org $(github_org) -github_repo $(github_repo) -username $(github_username) -pat $(github_access_token) -build_id $(Build.BuildId) -src_folder $(Build.ArtifactStagingDirectory) -baseline_branch staging'


